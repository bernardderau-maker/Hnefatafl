<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hnefatafl - Viking Chess</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>

<body>
    <div class="game-container">
        <header class="game-header">
            <h1>Hnefatafl</h1>
            <div class="turn-indicator" id="turn-indicator">
                <div class="turn-info">
                    <span class="turn-label">Current Turn:</span>
                    <span id="current-player" class="player-text">Attackers</span>
                </div>
                <!-- Timer Display (Hidden if Off) -->
                <div id="timer-display-area"
                    style="margin-top: 10px; display: none; gap: 20px; justify-content: center; width: 100%;">
                    <div class="timer-box attacker-timer-box">
                        <span style="color: grey;">Attackers:</span> <span id="attacker-timer">05:00</span>
                    </div>
                    <div class="timer-box defender-timer-box">
                        <span style="color: #d7ccc8;">Defenders:</span> <span id="defender-timer">05:00</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="game-board-container">
                <div id="game-board" class="game-board">
                    <!-- Board cells will be generated by JS -->
                </div>
            </div>

            <aside class="sidebar">
                <!-- User Profile Panel -->
                <div class="panel user-panel" id="user-panel">
                    <div id="logged-out-view">
                        <button id="auth-entry-btn" class="viking-btn">Login / Sign Up</button>
                    </div>
                    <div id="logged-in-view" class="hidden-soft">
                        <div class="user-profile">
                            <div class="avatar-container">
                                <img id="user-avatar" src="roi.png" alt="Avatar">
                            </div>
                            <div class="user-info">
                                <span id="user-display-name">Viking Warrior</span>
                                <button id="logout-btn" class="text-link">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel status-panel">
                    <h2>Game Status</h2>
                    <div class="stat-item">
                        <span>Moves:</span>
                        <span id="move-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Attackers Captured:</span>
                        <span id="captured-attackers">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Defenders Captured:</span>
                        <span id="captured-defenders">0</span>
                    </div>
                </div>

                <div class="panel controls-panel">
                    <button id="new-game-btn" class="viking-btn">New Game</button>
                    <button id="rules-btn" class="viking-btn secondary">Rules</button>
                </div>

                <div class="panel history-panel">
                    <h3>Move History</h3>
                    <ul id="move-history-list"></ul>
                </div>

                <div class="panel leaderboard-panel">
                    <h3>Hall of Heroes</h3>
                    <ul id="leaderboard-list">
                        <li class="empty-msg">No legends yet...</li>
                    </ul>
                </div>

                <!-- Daily Challenges Panel -->
                <div class="panel challenges-panel">
                    <h3>Daily Challenges</h3>
                    <div id="challenges-list">
                        <div class="challenge-item">
                            <span class="challenge-desc">Win 10 games today</span>
                            <div class="challenge-progress-bar">
                                <div id="win-challenge-progress" class="progress" style="width: 0%"></div>
                            </div>
                            <span id="win-challenge-text" class="challenge-stat">0/10</span>
                        </div>
                        <div class="challenge-item">
                            <span class="challenge-desc">Invite a friend to play</span>
                            <span id="invite-challenge-status"
                                class="challenge-stat status-incomplete">Incomplete</span>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Rules of Hnefatafl</h2>
            <div class="rules-text">
                <p><strong>Goal:</strong> Defenders must help the King reach any of the four corners. Attackers must
                    capture the King.</p>
                <p><strong>Movement:</strong> Pieces move like Rooks in Chess (any distance orthogonally).</p>
                <p><strong>Capture:</strong> Sandwich an enemy piece between two of yours to capture it.</p>
                <p><strong>King Capture:</strong> The King must be surrounded on 4 sides (or 3 sides against the
                    throne/edge).</p>
                <p><strong>Throne/Corners:</strong> Only the King can land on the central Throne or Corner Refuges.</p>
            </div>
        </div>
    </div>

    <!-- Victory Modal -->
    <div id="victory-modal" class="modal hidden">
        <div class="modal-content victory-content">
            <h2 id="victory-title">Victory!</h2>
            <p id="victory-message">Defenders have escaped!</p>

            <div class="score-display">
                <span class="score-label">Final Score:</span>
                <span id="final-score" class="score-value">0</span>
            </div>

            <div id="score-save-container" class="hidden-soft">
                <p>Record your name in the sagas:</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
                    <input type="text" id="player-name" placeholder="Viking Name" class="viking-select"
                        style="text-align: center; width: 150px;">
                    <button id="save-score-btn" class="viking-btn"
                        style="width: auto; margin: 0; padding: 5px 15px; font-size: 1rem;">Save</button>
                </div>
            </div>

            <button id="play-again-btn" class="viking-btn">Play Again</button>
        </div>
    </div>

    <!-- Game Setup Modal -->
    <div id="setup-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" id="close-setup-modal">&times;</span>
            <h2>New Game</h2>

            <!-- Game Mode Selection -->
            <div class="setup-section">
                <h3>Game Mode</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <button id="mode-vs-ai" class="viking-btn mode-btn active-mode">Vs AI</button>
                    <button id="mode-2p-local" class="viking-btn mode-btn">2 Players (Local)</button>
                    <button id="mode-random" class="viking-btn mode-btn"
                        style="background: linear-gradient(135deg, #422814 0%, #a27a3d 100%); border: 1px solid var(--color-gold);">Recherche
                        Al√©atoire</button>
                    <button id="mode-2p-direct" class="viking-btn mode-btn">Interconnexion Directe</button>
                </div>
            </div>

            <!-- Online Mode Section -->
            <div class="setup-section" id="online-section" style="margin-top: 20px; display: none;">
                <h3>Online Multiplayer</h3>
                <div id="online-status" style="margin-bottom: 10px; font-size: 0.9rem; color: var(--color-gold);">
                    Status: Disconnected</div>

                <!-- Host Section -->
                <div id="host-section" style="margin-bottom: 15px;">
                    <p style="font-size: 0.8rem; margin-bottom: 5px;">Your Invite Code:</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="peer-id-display" readonly class="viking-select"
                            style="flex: 1; border: 1px solid var(--color-gold-dim); padding: 5px; text-align: center;"
                            placeholder="Generating code...">
                        <button id="copy-id-btn" class="viking-btn secondary"
                            style="width: auto; margin: 0; padding: 5px 15px; font-size: 0.8rem;">Copy</button>
                    </div>
                </div>

                <!-- Join Section -->
                <div id="join-section">
                    <p style="font-size: 0.8rem; margin-bottom: 5px;">Join a Friend:</p>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="join-id-input" class="viking-select"
                            style="flex: 1; border: 1px solid var(--color-gold-dim); padding: 5px; text-align: center;"
                            placeholder="Enter invite code">
                        <button id="connect-btn" class="viking-btn secondary"
                            style="width: auto; margin: 0; padding: 5px 15px; font-size: 0.8rem;">Join</button>
                    </div>
                </div>
            </div>

            <!-- Side Selection (only for VS AI or Online Host) -->
            <div class="setup-section" id="side-selection" style="margin-top: 20px;">
                <h3>Choose Your Side</h3>
                <p id="side-help-text" style="font-size: 0.9rem; color: var(--color-wood-pale);">Attackers move first.
                </p>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 10px;">
                    <button id="side-attackers" class="viking-btn secondary side-btn">Attackers (Black)</button>
                    <button id="side-defenders" class="viking-btn secondary side-btn active-side">Defenders
                        (White)</button>
                </div>
            </div>

            <!-- Timer Settings -->
            <div class="setup-section" style="margin-top: 20px;">
                <h3>Timer</h3>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="timer-enabled" style="width: 18px; height: 18px; cursor: pointer;">
                        <span>Enable Timer</span>
                    </label>
                    <select id="timer-duration" class="viking-select" disabled
                        style="background: rgba(40,30,20,0.8); color: #c5a059; border: 1px solid #c5a059; padding: 5px 10px; border-radius: 4px;">
                        <option value="5">5 Minutes</option>
                        <option value="10">10 Minutes</option>
                        <option value="15">15 Minutes</option>
                        <option value="30">30 Minutes</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button id="start-game-btn" class="viking-btn">Start Game</button>
                <button id="cancel-setup-btn" class="viking-btn secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal hidden">
        <div class="modal-content auth-content">
            <span class="close-modal" id="close-auth-modal">&times;</span>

            <!-- Login State -->
            <div id="auth-state-login" class="auth-state">
                <h2>Join the Sagas</h2>
                <div class="oauth-buttons">
                    <button id="google-login-btn" class="oauth-btn google">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
                        Continue with Google
                    </button>
                </div>
                <div class="divider"><span>OR</span></div>
                <div class="auth-form">
                    <input type="email" id="login-email" placeholder="Email Address" class="viking-select">
                    <input type="password" id="login-password" placeholder="Password" class="viking-select">
                    <button id="email-login-btn" class="viking-btn">Login</button>
                    <p class="auth-switch"><a href="#" id="goto-reset">Mot de passe oubli√© ?</a></p>
                </div>
                <p class="auth-switch">New to Hnefatafl? <a href="#" id="goto-signup">Create an account</a></p>
            </div>

            <!-- Signup State -->
            <div id="auth-state-signup" class="auth-state hidden-soft">
                <h2>Create Account</h2>
                <div class="auth-form">
                    <input type="text" id="signup-name" placeholder="Full Name" class="viking-select">
                    <input type="email" id="signup-email" placeholder="Email Address" class="viking-select">
                    <input type="password" id="signup-password" placeholder="Password" class="viking-select">
                    <button id="send-code-btn" class="viking-btn">Send Confirmation Code</button>
                </div>
                <p class="auth-switch">Already have an account? <a href="#" id="goto-login">Login</a></p>
            </div>

            <!-- Verification State -->
            <div id="auth-state-verify" class="auth-state hidden-soft">
                <h2>Confirm Email</h2>
                <p style="font-size: 0.9rem; text-align: center; margin-bottom: 20px;">A verification code was sent to
                    your email. Enter it below to continue.</p>
                <div class="auth-form">
                    <div class="code-input-container">
                        <input type="text" maxlength="6" id="verify-code" placeholder="123456"
                            class="viking-select code-input">
                    </div>
                    <button id="verify-btn" class="viking-btn">Verify & Create Account</button>
                </div>
                <p class="auth-switch"><a href="#" id="resend-code">Resend code</a></p>
            </div>

            <!-- Reset Password State -->
            <div id="auth-state-reset" class="auth-state hidden-soft">
                <h2>R√©tablir l'acc√®s</h2>
                <p style="font-size: 0.9rem; text-align: center; margin-bottom: 20px;">Indiquez votre email pour
                    recevoir un lien de r√©initialisation.</p>
                <div class="auth-form">
                    <input type="email" id="reset-email" placeholder="Email Address" class="viking-select">
                    <button id="send-reset-btn" class="viking-btn">Envoyer le lien</button>
                </div>
                <p class="auth-switch"><a href="#" id="goto-login-from-reset">Retour √† la connexion</a></p>
            </div>

            <!-- Profile Setup State -->
            <div id="auth-state-profile" class="auth-state hidden-soft">
                <h2>Finish Your Profile</h2>
                <div class="auth-form">
                    <div class="profile-pic-preview">
                        <img id="setup-avatar-preview" src="roi.png" alt="Preview">
                        <label for="avatar-upload" class="avatar-upload-label">
                            <span class="icon">üì∑</span>
                        </label>
                        <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                    </div>
                    <input type="text" id="setup-username" placeholder="Viking Nickname" class="viking-select">
                    <button id="finish-profile-btn" class="viking-btn">Enter the Hall of Heroes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    <script src="auth.js"></script>
    <script src="game.js"></script>
</body>

</html>